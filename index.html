<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SYNAPPSE Order Request</title>
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/favicon-48x48.png" sizes="48x48">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">


    <link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180">

    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/android-chrome-512x512.png" sizes="512x512">

    <link rel="manifest" href="/site.webmanifest"> 
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK Initialization (Moved to external file) -->
    <!-- You MUST create a file named firebase-init.js in the same directory -->
    <!-- This file will contain the actual Firebase initialization code and config -->
    <script type="module" src="./firebase-init.js"></script>

    <style>
        /* Keyframe animation for new background gradient movement, now rotating through corners */
        @keyframes movingGradient {
            0% { background-position: 0% 0%; }    /* Top-left */
            25% { background-position: 100% 0%; }   /* Top-right */
            50% { background-position: 100% 100%; } /* Bottom-right */
            75% { background-position: 0% 100%; }   /* Bottom-left */
            100% { background-position: 0% 0%; }   /* Back to Top-left for seamless loop */
        }

        /* Keyframe for success checkmark animation */
        @keyframes drawCheck {
            0% {
                stroke-dashoffset: 1000;
                opacity: 0;
            }
            100% {
                stroke-dashoffset: 0;
                opacity: 1;
            }
        }

        body {
            font-family: 'Inter', sans-serif;
            /* Adjusted radial-gradient for even more subtle lighter movement and balanced darker shade */
            /* Removed 'circle at 50% 50%' to make the 'light' appear only with background-position animation */
            background: radial-gradient(rgba(255, 255, 255, 0.000001), #5A0DA0, #3A0070);
            background-size: 400% 400%; /* Larger background to allow for animation and smaller light appearance */
            animation: movingGradient 16s ease infinite; /* Apply the new moving gradient animation */
            color: #ffffff; /* White text for contrast */
            overflow-x: hidden; /* Prevent horizontal scrollbars due to animations */
            min-height: 100vh; /* Ensure body takes full viewport height */
        }
        /* Custom styles for input, textarea, and select focus states */
        input:focus, textarea:focus, select:focus {
            outline: none; /* Remove default outline */
            border-color: #fca311; /* Amber for focus border */
            box-shadow: 0 0 0 3px rgba(252, 163, 17, 0.5); /* Shadow with amber tint */
        }
        /* Style for all form fields (input, textarea, select) */
        .form-field {
            background-color: rgba(255, 255, 255, 0.1); /* Slightly transparent white for fields */
            border: 1px solid rgba(255, 255, 255, 0.3); /* Lighter border */
            color: #ffffff; /* White text within fields */
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease-in-out; /* Smooth transition for hover/focus */
        }
        .form-field::placeholder {
            color: rgba(255, 255, 255, 0.7); /* Lighter placeholder text */
        }
        .form-field:hover {
            background-color: rgba(255, 255, 255, 0.15); /* Slightly less transparent on hover */
        }
        .form-field:focus {
            background-color: rgba(255, 255, 255, 0.2); /* Even less transparent on focus */
        }
        /* Specific style for custom select dropdown options */
        .custom-dropdown-options {
            background-color: #6a0dad; /* Darker background for options */
        }
        .custom-dropdown-options li:hover {
            background-color: #8a2be2; /* Slightly lighter purple on hover */
        }

        /* Styling for primary button */
        .btn-primary {
            background-color: #fca311; /* Amber */
            color: #212529; /* Dark text for contrast */
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-primary:hover {
            background-color: #e69500; /* Darker amber on hover */
            transform: translateY(-2px); /* Slight lift effect */
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }
        /* Styling for secondary button */
        .btn-secondary {
            background-color: rgba(255, 255, 255, 0.2); /* Transparent white */
            color: #ffffff;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .btn-secondary:hover {
            background-color: rgba(255, 255, 255, 0.3); /* Slightly less transparent on hover */
            transform: translateY(-2px); /* Slight lift effect */
        }

        /* Custom CSS for mobile responsiveness */
        /* Make the main form container take more width on small screens */
        .form-container-responsive {
            padding-left: 1rem; /* px-4 */
            padding-right: 1rem; /* px-4 */
            max-width: 100%; /* Default to full width */
        }
        @media (min-width: 640px) { /* sm breakpoint and up */
            .form-container-responsive {
                padding-left: 2.5rem; /* sm:px-10 */
                padding-right: 2.5rem; /* sm:px-10 */
                max-width: 48rem; /* sm:max-w-4xl */
            }
        }
        
        /* Remove explicit max-width from inputs, let them fill their parent's space */
        @media (max-width: 639px) { /* Targets screens smaller than sm breakpoint */
            .date-time-input-group {
                /* Removed specific max-width from input[type="date"], input[type="time"] */
                /* The w-full on input will now respect the new parent container width */
                width: 100%; /* Ensure the flex item takes full width */
            }
            .date-time-input-group label,
            .date-time-input-group input {
                text-align: center; /* Center text and input fields */
            }
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4 sm:p-6 md:p-8">
    <!-- Firebase Status Indicator -->
    <!-- Hidden by default, shown only when status changes -->
    <div id="firebaseStatus" class="mb-4 text-center text-sm font-medium hidden">
        Connecting to Forms...
    </div>

    <!-- Main form container with responsive styling and background -->
    <div id="formContainer" class="w-full form-container-responsive mx-auto bg-purple-900 bg-opacity-70 rounded-xl shadow-2xl p-6 sm:p-10 space-y-8">
        <h1 class="text-4xl sm:text-5xl font-extrabold text-white text-center mb-6 drop-shadow-lg">SYNAPPSE Order Request</h1>
        
        <!-- Progress Indicator for multi-step form -->
        <div class="flex justify-center space-x-2 sm:space-x-4 mb-8">
            <div id="step-indicator-1" class="w-8 h-8 sm:w-10 sm:h-10 rounded-full flex items-center justify-center text-sm sm:text-base font-bold bg-white text-purple-700 shadow-md">1</div>
            <div id="step-indicator-2" class="w-8 h-8 sm:w-10 sm:h-10 rounded-full flex items-center justify-center text-sm sm:text-base font-bold bg-gray-300 text-gray-700 shadow-md">2</div>
            <div id="step-indicator-3" class="w-8 h-8 sm:w-10 sm:h-10 rounded-full flex items-center justify-center text-sm sm:text-base font-bold bg-gray-300 text-gray-700 shadow-md">3</div>
        </div>

        <form id="orderForm" class="space-y-6">
            <!-- Step 1: Order Details -->
            <div id="step1" class="form-step">
                <h3 class="text-2xl sm:text-3xl font-bold text-white mb-6 text-center">Order Details</h3>
                <p class="text-sm text-gray-200 text-center mb-8">All fields in this section are required.</p>

                <div class="relative">
                    <label for="typeOfOrder" class="block text-base font-medium text-gray-100 mb-2">Type of Order</label>
                    <div id="customDropdownButton" class="mt-1 block w-full form-field cursor-pointer flex justify-between items-center" tabindex="0" role="combobox" aria-haspopup="listbox" aria-expanded="false" aria-controls="dropdownOptions">
                        <span id="selectedOptionText">Select Order Type</span>
                        <svg class="w-5 h-5 text-white transform transition-transform duration-200" id="dropdownArrow" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <input type="hidden" id="typeOfOrder" name="typeOfOrder" required value="">
                    
                    <ul id="dropdownOptions" class="absolute z-10 w-full mt-1 rounded-md shadow-lg overflow-hidden hidden custom-dropdown-options" role="listbox" aria-labelledby="customDropdownButton">
                        <li class="px-4 py-2 cursor-pointer text-white" data-value="Branding">Branding</li>
                        <li class="px-4 py-2 cursor-pointer text-white" data-value="Web Design">Web Design</li>
                        <li class="px-4 py-2 cursor-pointer text-white" data-value="Marketing Campaign">Marketing Campaign</li>
                        <li class="px-4 py-2 cursor-pointer text-white" data-value="Content Creation">Content Creation</li>
                        <li class="px-4 py-2 cursor-pointer text-white" data-value="Market Research">Market Research</li>
                        <li class="px-4 py-2 cursor-pointer text-white" data-value="System Development">System Development</li>
                        <li class="px-4 py-2 cursor-pointer text-white" data-value="Printed Materials">Printed Materials</li>
                        <li class="px-4 py-2 cursor-pointer text-white" data-value="Personal Websites">Personal Websites</li>
                        <li class="px-4 py-2 cursor-pointer text-white" data-value="Other">Other</li>
                    </ul>
                </div>

                <div>
                    <label for="detailedDescription" class="block text-base font-medium text-gray-100 mb-2">Detailed Description</label>
                    <textarea id="detailedDescription" name="detailedDescription" rows="6" placeholder="Provide a detailed description of your project or request..." required
                                  class="mt-1 block w-full form-field"></textarea>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div class="w-full flex flex-col items-center date-time-input-group"> <!-- Flex column to center label/input vertically -->
                        <label for="meetingDate" class="block text-base font-medium text-gray-100 mb-2">Schedule a Meeting - Date</label>
                        <input type="date" id="meetingDate" name="meetingDate" required
                               class="mt-1 block w-full form-field">
                    </div>
                    <div class="w-full flex flex-col items-center date-time-input-group"> <!-- Flex column to center label/input vertically -->
                        <label for="meetingTime" class="block text-base font-medium text-gray-100 mb-2">Schedule a Meeting - Time</label>
                        <input type="time" id="meetingTime" name="meetingTime" required
                               class="mt-1 block w-full form-field">
                    </div>
                </div>
                <button type="button" id="checkAvailabilityBtn" class="btn-secondary w-full sm:w-auto mt-4">Check Availability</button>
                <div id="availabilityMessage" class="mt-2 text-sm font-semibold text-center"></div>

                <div class="flex justify-end mt-8">
                    <button type="button" id="next1" class="btn-primary">Next</button>
                </div>
            </div>

            <!-- Step 2: Client Information -->
            <div id="step2" class="form-step hidden">
                <h3 class="text-2xl sm:text-3xl font-bold text-white mb-6 text-center">Client Information</h3>
                <p class="text-sm text-gray-200 text-center mb-8">All fields in this section are required.</p>

                <div>
                    <label for="fullName" class="block text-base font-medium text-gray-100 mb-2">Full Name</label>
                    <input type="text" id="fullName" name="fullName" placeholder="Your Full Name" required
                           class="mt-1 block w-full form-field">
                </div>

                <div>
                    <label for="emailAddress" class="block text-base font-medium text-gray-100 mb-2">Email Address</label>
                    <input type="email" id="emailAddress" name="emailAddress" placeholder="you@example.com" required
                           class="mt-1 block w-full form-field">
                </div>

                <div>
                    <label for="phoneNumber" class="block text-base font-medium text-gray-100 mb-2">Phone Number</label>
                    <input type="text" id="phoneNumber" name="phoneNumber" placeholder="+63 9XX XXX XXXX" required
                           class="mt-1 block w-full form-field"
                           oninput="this.value=this.value.replace(/[^0-9]/g,'');" maxlength="15">
                </div>

                <div class="flex justify-between mt-8">
                    <button type="button" id="prev2" class="btn-secondary">Previous</button>
                    <button type="button" id="next2" class="btn-primary">Next</button>
                </div>
            </div>

            <!-- Step 3: Social Media and Links -->
            <div id="step3" class="form-step hidden">
                <h3 class="text-2xl sm:text-3xl font-bold text-white mb-6 text-center">Social Media and Links</h3>
                <p class="text-sm text-gray-200 text-center mb-8">All fields in this section are optional.</p>

                <div>
                    <label for="facebookProfile" class="block text-base font-medium text-gray-100 mb-2">Facebook Profile/Page URL</label>
                    <input type="url" id="facebookProfile" name="facebookProfile" placeholder="https://facebook.com/yourpage"
                           class="mt-1 block w-full form-field">
                </div>

                <div>
                    <label for="instagramHandle" class="block text-base font-medium text-gray-100 mb-2">Instagram Handle</label>
                    <input type="text" id="instagramHandle" name="instagramHandle" placeholder="@yourinstagram"
                           class="mt-1 block w-full form-field">
                </div>

                <div>
                    <label for="twitterHandle" class="block text-base font-medium text-gray-100 mb-2">Twitter/X Handle</label>
                    <input type="text" id="twitterHandle" name="twitterHandle" placeholder="@yourtwitterx"
                           class="mt-1 block w-full form-field">
                </div>

                <div class="flex justify-between mt-8">
                    <button type="button" id="prev3" class="btn-secondary">Previous</button>
                    <button type="submit" class="btn-primary">Submit Order Request</button>
                </div>
            </div>

            <div id="formMessage" class="mt-4 text-center text-sm font-medium text-white"></div>
        </form>
    </div>

    <!-- Success Message Container (Initially Hidden) -->
    <div id="successMessageContainer" class="w-full max-w-4xl mx-auto bg-purple-900 bg-opacity-70 rounded-xl shadow-2xl p-6 sm:p-10 space-y-8 hidden flex flex-col items-center justify-center text-center">
        <svg class="w-32 h-32 text-green-400 mb-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="animation: drawCheck 1s forwards ease-out;">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-8.87"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
        </svg>
        <h2 class="text-4xl sm:text-5xl font-extrabold text-white mb-4 drop-shadow-lg">Thank You!</h2>
        <p class="text-lg text-gray-200 mb-8">Your order request has been submitted successfully. Here are the details:</p>
        <div id="submittedDetails" class="text-left text-gray-200 w-full max-w-md">
            <!-- Submitted details will be inserted here -->
        </div>
        <button type="button" id="fillAgainBtn" class="btn-primary mt-8">Fill Another Request</button>
    </div>

    <script type="module">
        // Import necessary Firebase modules for this script block
        import { collection, query, where, getDocs, addDoc, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Declare global Firebase variables to be populated from the initial script block (firebase-init.js)
        let db;
        let userId;
        let appId;
        // Timestamp is already imported above, so no need to redeclare here.

        /**
         * Updates the Firebase status message on the UI.
         * @param {string} message - The message to display.
         * @param {string} type - 'success', 'error', or 'connecting'.
         */
        const updateFirebaseStatusUI = (message, type) => {
            const statusElement = document.getElementById('firebaseStatus');
            if (statusElement) {
                statusElement.textContent = message;
                statusElement.classList.remove('text-green-500', 'text-red-500', 'text-yellow-500'); // Reset colors

                if (type === 'success') {
                    statusElement.classList.add('text-green-500');
                    statusElement.classList.remove('hidden'); // Show on success
                } else if (type === 'error') {
                    statusElement.classList.add('text-red-500');
                    statusElement.classList.remove('hidden'); // Show on error
                } else if (type === 'connecting') {
                    statusElement.classList.add('text-yellow-500');
                    statusElement.classList.remove('hidden'); // Show on connecting
                } else {
                    statusElement.classList.add('hidden'); // Hide for other or unknown states
                }
            }
        };


        /**
         * Checks if Firebase is initialized and its global variables are available.
         * Resolves when ready, or rejects if it times out.
         * @returns {Promise<void>}
         */
        const checkFirebaseReady = () => {
            return new Promise((resolve, reject) => {
                let checkCount = 0;
                const maxChecks = 50; // Try for 5 seconds (50 checks * 100ms)
                const interval = setInterval(() => {
                    // Check if window properties set by firebase-init.js are available
                    if (window.db && window.userId && window.appId) {
                        db = window.db; // Assign to local module variables
                        userId = window.userId;
                        appId = window.appId;
                        clearInterval(interval);
                        console.log("main.js: Firebase globals are ready in main script.");
                        updateFirebaseStatusUI("Forms are updated in real time.", "success");
                        resolve();
                    } else if (checkCount >= maxChecks) {
                        clearInterval(interval);
                        const errorMessage = `Firebase initialization timed out. Globals status: db=${!!window.db}, userId=${!!window.userId}, appId=${!!window.appId}`;
                        console.error("main.js:", errorMessage);
                        updateFirebaseStatusUI("Forms are offline: Initialization error.", "error"); // Specific error
                        reject(new Error(errorMessage)); // Reject the promise on timeout
                    }
                    checkCount++;
                }, 100);
            });
        };
        
        // Initial status update when the main script loads
        updateFirebaseStatusUI("Connecting to Forms...", "connecting");


        // Get form and message elements
        const formContainer = document.getElementById('formContainer'); // Main container for the form
        const successMessageContainer = document.getElementById('successMessageContainer'); // New success message container
        const submittedDetailsDiv = document.getElementById('submittedDetails'); // Div to display submitted details
        const form = document.getElementById('orderForm');
        const formMessage = document.getElementById('formMessage');

        // Get form step elements and step indicator elements
        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const step3 = document.getElementById('step3');
        const stepIndicators = [
            document.getElementById('step-indicator-1'),
            document.getElementById('step-indicator-2'),
            document.getElementById('step-indicator-3')
        ];

        let currentStep = 1; // Track the current active step

        // Form Elements for Validation - references to input fields
        // Note: typeOfOrder is now managed by a custom dropdown
        const detailedDescription = document.getElementById('detailedDescription');
        const meetingDate = document.getElementById('meetingDate');
        const meetingTime = document.getElementById('meetingTime');
        const fullName = document.getElementById('fullName');
        const emailAddress = document.getElementById('emailAddress');
        const phoneNumber = document.getElementById('phoneNumber');

        // Meeting Availability Elements
        const checkAvailabilityBtn = document.getElementById('checkAvailabilityBtn');
        const availabilityMessage = document.getElementById('availabilityMessage');
        const fillAgainBtn = document.getElementById('fillAgainBtn'); // New button

        // Custom Dropdown Elements
        const customDropdownButton = document.getElementById('customDropdownButton');
        const selectedOptionText = document.getElementById('selectedOptionText');
        const dropdownOptions = document.getElementById('dropdownOptions');
        const dropdownArrow = document.getElementById('dropdownArrow'); // Corrected
        const typeOfOrderHiddenInput = document.getElementById('typeOfOrder'); // Hidden input for value


        // IMPORTANT: Replace with your deployed FormEasy Apps Script Web App URL
        // This endpoint is used to submit form data to a Google Sheet via Google Apps Script.
        const FORM_EASY_ENDPOINT = 'https://script.google.com/macros/s/AKfycbzZM7f-hnDPnMJVPu7FrEsrWTDqHSMIsiOpNguIyqcIYZeKGbl1H0jUWrI_g77YAnTPBg/exec'; 

        /**
         * Updates the visual appearance of the step indicators based on the current step.
         */
        function updateStepIndicators() {
            stepIndicators.forEach((indicator, index) => {
                if (index + 1 === currentStep) {
                    // Current step: white background, purple text
                    indicator.classList.add('bg-white', 'text-purple-700');
                    indicator.classList.remove('bg-gray-300', 'text-gray-700', 'bg-purple-400', 'text-white');
                } else if (index + 1 < currentStep) {
                    // Completed step: purple background, white text
                    indicator.classList.add('bg-purple-400', 'text-white');
                    indicator.classList.remove('bg-white', 'text-purple-700', 'bg-gray-300', 'text-gray-700');
                } else {
                    // Future step: gray background, gray text
                    indicator.classList.add('bg-gray-300', 'text-gray-700');
                    indicator.classList.remove('bg-white', 'text-purple-700', 'bg-purple-400', 'text-white');
                }
            });
        }

        /**
         * Shows a specific form step and hides others.
         * @param {number} stepNum - The step number to show (1, 2, or 3).
         */
        function showStep(stepNum) {
            // Hide all steps first
            step1.classList.add('hidden');
            step2.classList.add('hidden');
            step3.classList.add('hidden');
            
            // Show the requested step
            switch(stepNum) {
                case 1: step1.classList.remove('hidden'); break;
                case 2: step2.classList.remove('hidden'); break;
                case 3: step3.classList.remove('hidden'); break;
            }
            currentStep = stepNum; // Update current step tracker
            updateStepIndicators(); // Update visual indicators
        }

        // Initial display when the page loads
        showStep(1);

        /**
         * Validates fields in Step 1.
         * @returns {boolean} True if all required fields in Step 1 are valid and availability is confirmed, false otherwise.
         */
        function validateStep1() {
            // Clear any previous messages
            formMessage.textContent = '';
            formMessage.classList.remove('text-red-300', 'text-green-300', 'text-yellow-300');

            // Check HTML5 validation for required fields in Step 1
            const requiredFields1 = [detailedDescription, meetingDate, meetingTime]; 
            for (const field of requiredFields1) {
                if (!field.checkValidity()) {
                    field.reportValidity(); // Show native browser error
                    formMessage.textContent = `Please fill out the "${field.previousElementSibling.textContent.trim()}" field.`;
                    formMessage.classList.add('text-red-300');
                    return false;
                }
            }

            // Custom validation for the custom dropdown
            if (!typeOfOrderHiddenInput.value) { // Use the hidden input's value for validation
                formMessage.textContent = 'Please select a "Type of Order".';
                formMessage.classList.add('text-red-300');
                customDropdownButton.focus(); // Set focus to the dropdown button
                return false;
            }


            // Check if meeting availability has been checked and is positive
            if (!availabilityMessage.classList.contains('text-green-500')) {
                formMessage.textContent = 'Please check meeting availability and ensure the selected slot is available.';
                formMessage.classList.add('text-red-300');
                return false;
            }
            return true;
        }

        /**
         * Validates fields in Step 2.
         * @returns {boolean} True if all required fields in Step 2 are valid, false otherwise.
         */
        function validateStep2() {
            // Clear any previous messages
            formMessage.textContent = '';
            formMessage.classList.remove('text-red-300', 'text-green-300', 'text-yellow-300');

            const requiredFields2 = [fullName, emailAddress, phoneNumber];
            for (const field of requiredFields2) {
                if (!field.checkValidity()) {
                    field.reportValidity(); // Show native browser error
                    formMessage.textContent = `Please fill out the "${field.previousElementSibling.textContent.trim()}" field.`;
                    formMessage.classList.add('text-red-300');
                    return false;
                }
            }
            return true;
        }

        // Event Listeners for Navigation Buttons
        document.getElementById('next1').addEventListener('click', () => {
            if (validateStep1()) {
                showStep(2); // Move to Step 2 if Step 1 is valid
            }
        });

        document.getElementById('prev2').addEventListener('click', () => {
            showStep(1); // Go back to Step 1
        });

        document.getElementById('next2').addEventListener('click', () => {
            if (validateStep2()) {
                showStep(3); // Move to Step 3 if Step 2 is valid
            }
            // No error handling needed here directly, validation handles it.
        });

        document.getElementById('prev3').addEventListener('click', () => {
            showStep(2); // Go back to Step 2
        });

        // Firebase Meeting Availability Check
        checkAvailabilityBtn.addEventListener('click', async () => {
            try {
                // Ensure Firebase is ready before attempting database operations
                // checkFirebaseReady will now reject on timeout or auth failure, handled by catch block.
                await checkFirebaseReady(); 
                
                const date = meetingDate.value;
                const time = meetingTime.value;

                // Validate if date and time are selected
                if (!date || !time) {
                    availabilityMessage.textContent = 'Please select both date and time.';
                    availabilityMessage.classList.remove('text-green-500', 'text-yellow-500');
                    availabilityMessage.classList.add('text-red-500');
                    return;
                }

                // Combine date and time into a single Date object for Firestore comparison
                const selectedDateTime = new Date(`${date}T${time}:00`);

                availabilityMessage.textContent = 'Checking availability...';
                availabilityMessage.classList.remove('text-green-500', 'text-red-500');
                availabilityMessage.classList.add('text-yellow-500');

                // db, userId, appId are now guaranteed to be available if checkFirebaseReady resolved
                const meetingsRef = collection(db, 'artifacts', appId, 'public', 'data', 'bookedMeetings');
                const q = query(meetingsRef, where('dateTime', '==', Timestamp.fromDate(selectedDateTime)));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    // Slot is available
                    availabilityMessage.textContent = '✅ This slot is available!';
                    availabilityMessage.classList.remove('text-red-500', 'text-yellow-500');
                    availabilityMessage.classList.add('text-green-500');
                } else {
                    // Slot is already booked
                    availabilityMessage.textContent = '❌ This slot is already booked. Please choose another time.';
                    availabilityMessage.classList.remove('text-green-500', 'text-yellow-500');
                    availabilityMessage.classList.add('text-red-500');
                }
            } catch (error) {
                console.error("Error checking meeting availability:", error);
                // Display the specific error message from the rejection
                availabilityMessage.textContent = `Error checking availability: ${error.message}. Please check console for details.`; 
                availabilityMessage.classList.remove('text-green-500', 'text-yellow-500');
                availabilityMessage.classList.add('text-red-500');
            }
        });

        // Function to convert 24-hour time to 12-hour AM/PM format
        function formatTimeForDisplay(time24h) {
            if (!time24h) return '';
            const [hours, minutes] = time24h.split(':').map(Number);
            const period = hours >= 12 ? 'PM' : 'AM';
            const formattedHours = hours % 12 || 12; // Convert 0 (midnight) to 12 AM, and hours > 12 to 12-hour format
            return `${formattedHours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')} ${period}`;
        }

        // Custom Dropdown Logic
        customDropdownButton.addEventListener('click', () => {
            const isExpanded = customDropdownButton.getAttribute('aria-expanded') === 'true';
            customDropdownButton.setAttribute('aria-expanded', !isExpanded);
            dropdownOptions.classList.toggle('hidden', isExpanded);
            dropdownArrow.classList.toggle('rotate-180', !isExpanded);
        });

        // Event listener for selecting an option in the custom dropdown
        dropdownOptions.addEventListener('click', (event) => {
            const selectedLi = event.target.closest('li');
            if (selectedLi) {
                const value = selectedLi.dataset.value;
                const text = selectedLi.textContent;
                selectedOptionText.textContent = text;
                typeOfOrderHiddenInput.value = value; // Update the hidden input's value
                customDropdownButton.setAttribute('aria-expanded', 'false');
                dropdownOptions.classList.add('hidden');
                dropdownArrow.classList.remove('rotate-180');
            }
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (event) => {
            if (!customDropdownButton.contains(event.target) && !dropdownOptions.contains(event.target)) {
                customDropdownButton.setAttribute('aria-expanded', 'false');
                dropdownOptions.classList.add('hidden');
                dropdownArrow.classList.remove('rotate-180');
            }
        });

        // Form Submission Handler
        form.addEventListener('submit', async (event) => {
            event.preventDefault(); // Prevent default form submission to handle it via JavaScript

            // Final validation for step 2 before submission (Step 3 fields are optional)
            if (!validateStep2()) {
                showStep(2); // Go back to step 2 if invalid
                return;
            }
            // Ensure meeting slot is confirmed available before final submission
            if (!availabilityMessage.classList.contains('text-green-500')) {
                formMessage.textContent = 'Please re-check meeting availability and ensure it is available before submitting.';
                formMessage.classList.remove('text-green-300');
                formMessage.classList.add('text-red-300');
                showStep(1); // Go back to step 1 to re-check
                return;
            }

            formMessage.textContent = ''; // Clear previous messages
            formMessage.className = 'mt-4 text-center text-sm font-medium text-white'; // Reset classes

            const formData = new FormData(form);
            const data = {};
            // Convert FormData to a plain object for JSON submission
            formData.forEach((value, key) => {
                data[key] = value;
            });

            // Store original 24-hour time for Firestore Timestamp, but send formatted for FormEasy
            const originalMeetingTime24h = meetingTime.value; // Use the direct input value here

            // Format meetingTime for both display and Google Sheet
            if (originalMeetingTime24h) {
                data.meetingTime = formatTimeForDisplay(originalMeetingTime24h);
            }

            // The value of typeOfOrder is now taken from the hidden input
            data.typeOfOrder = typeOfOrderHiddenInput.value;

            // Show a loading message during submission
            formMessage.textContent = 'Submitting order request...';
            formMessage.classList.add('text-yellow-300');

            try {
                // First, attempt to submit data to the FormEasy Apps Script endpoint
                const response = await fetch(FORM_EASY_ENDPOINT, {
                    method: 'POST',
                    mode: 'no-cors', // 'no-cors' is often required for Google Apps Script deployments
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8', // FormEasy expects this content type
                    },
                    body: JSON.stringify(data), // Send data as a JSON string
                });

                // Since 'no-cors' mode is used, we cannot inspect the response directly.
                // We assume success here and proceed to book the meeting in Firebase.
                if (db && userId && appId) {
                    const selectedDate = meetingDate.value;
                    // Use original 24-hour time for creating the Date object for Firestore Timestamp
                    const dateTimeForBooking = new Date(`${selectedDate}T${originalMeetingTime24h}:00`);

                    const meetingsRef = collection(db, 'artifacts', appId, 'public', 'data', 'bookedMeetings');
                    
                    // Add the meeting booking to Firestore
                    await addDoc(meetingsRef, {
                        dateTime: Timestamp.fromDate(dateTimeForBooking), // Store meeting date/time as Firestore Timestamp
                        bookedBy: userId, // Record the user who booked it
                        clientEmail: data.emailAddress, // Store client email for reference
                        clientName: data.fullName, // Store client name
                        orderType: data.typeOfOrder, // Store order type from the form
                        createdAt: Timestamp.now() // Record when the booking was created
                    });
                    console.log("Meeting successfully booked in Firestore:", dateTimeForBooking);
                } else {
                    console.warn("Firebase not initialized or userId/appId missing, meeting not booked in Firestore.");
                }

                // Populate submitted details on the success page
                let detailsHtml = '';
                // Mapping of form field names to more readable labels
                const fieldLabels = {
                    typeOfOrder: 'Type of Order',
                    detailedDescription: 'Detailed Description',
                    meetingDate: 'Meeting Date',
                    meetingTime: 'Meeting Time', // This will now be the formatted time (AM/PM)
                    fullName: 'Full Name',
                    emailAddress: 'Email Address',
                    phoneNumber: 'Phone Number',
                    facebookProfile: 'Facebook Profile/Page URL',
                    instagramHandle: 'Instagram Handle',
                    twitterHandle: 'Twitter/X Handle'
                };
                for (const key in data) {
                    if (data.hasOwnProperty(key) && data[key]) { // Only display fields that have a value
                        const label = fieldLabels[key] || key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase()); // Convert camelCase to readable
                        detailsHtml += `<p class="mb-2"><span class="font-bold text-amber-200">${label}:</span> ${data[key]}</p>`;
                    }
                }
                submittedDetailsDiv.innerHTML = detailsHtml;


                // Hide the form container and show the success message container
                formContainer.classList.add('hidden');
                successMessageContainer.classList.remove('hidden');

                // Clear form message as we are now on a new page
                formMessage.textContent = ''; 
                formMessage.classList.remove('text-yellow-300', 'text-red-300', 'text-green-300');

                // Reset step indicators visually for potential next fill
                stepIndicators.forEach(indicator => {
                    indicator.classList.remove('bg-purple-400', 'text-white', 'bg-white', 'text-purple-700');
                    indicator.classList.add('bg-gray-300', 'text-gray-700');
                });
                stepIndicators[0].classList.add('bg-white', 'text-purple-700'); // Set first indicator active for next fill

            } catch (error) {
                // This catch block now handles errors from checkFirebaseReady() as well.
                console.error('Error submitting form or booking meeting:', error);
                formMessage.textContent = `There was an error submitting your request: ${error.message}. Please try again.`;
                formMessage.classList.remove('text-yellow-300', 'text-green-300');
                formMessage.classList.add('text-red-300');
            }
        });

        // Event listener for "Fill Another Request" button
        fillAgainBtn.addEventListener('click', () => {
            successMessageContainer.classList.add('hidden'); // Hide success message
            formContainer.classList.remove('hidden'); // Show form container
            form.reset(); // Reset the form fields
            
            // Reset custom dropdown state
            selectedOptionText.textContent = 'Select Order Type';
            typeOfOrderHiddenInput.value = ''; // Clear the hidden input's value
            customDropdownButton.setAttribute('aria-expanded', 'false');
            dropdownOptions.classList.add('hidden');
            dropdownArrow.classList.remove('rotate-180');


            showStep(1); // Go back to the first step
            availabilityMessage.textContent = ''; // Clear availability message
            availabilityMessage.classList.remove('text-green-500', 'text-red-500', 'text-yellow-500');
        });


        // Ensure Firebase is ready before allowing any interactions that depend on it.
        // This is crucial because the Firebase SDK script loads asynchronously.
        window.onload = async () => {
            // Update initial status when HTML loads, but before Firebase is fully ready
            updateFirebaseStatusUI("Connecting to Forms...", "connecting");
            try {
                await checkFirebaseReady(); // Wait for Firebase to be fully initialized and globals available
                console.log("All scripts loaded and Firebase ready for interactions.");
            } catch (error) {
                console.error("Firebase readiness check failed on onload:", error);
                // updateFirebaseStatusUI is already called inside checkFirebaseReady for rejection.
            }
        };

    </script>
</body>
</html>
